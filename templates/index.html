{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">‚ú® Latest Creations</h1>
    <div>
      <a href="{{ url_for('create_post') }}" class="btn btn-primary me-2">
        <i class="bi bi-plus-circle"></i> New Post
      </a>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
        <i class="bi bi-box-arrow-right"></i> Logout
      </a>
    </div>
  </div>

  <!-- Category Filter -->
  <div class="mb-4">
    <select class="form-select w-auto" onchange="location = this.value;">
      <option value="{{ url_for('home') }}" {% if not active_category %}selected{% endif %}>All Categories</option>
      <option value="{{ url_for('home') }}?category=Writing" {% if active_category == 'Writing' %}selected{% endif %}>‚úçÔ∏è Writing</option>
      <option value="{{ url_for('home') }}?category=Photography" {% if active_category == 'Photography' %}selected{% endif %}>üì∏ Photography</option>
      <option value="{{ url_for('home') }}?category=Paintings" {% if active_category == 'Paintings' %}selected{% endif %}>üé® Paintings</option>
    </select>
  </div>

  <!-- Posts Grid -->
  <div class="row g-4">
    {% for post in posts %}
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 shadow-sm">
        {% if post.img_url %}
        <div class="post-image" style="height: 200px; overflow: hidden;">
          <img src="{{ post.img_url }}?crop=fill&w=400&h=200" 
               class="img-fluid w-100 h-100" 
               alt="{{ post.title }}"
               style="object-fit: cover;">
        </div>
        {% endif %}
        
        <div class="card-body d-flex flex-column">
          <a href="{{ url_for('post_detail', post_id=post.id) }}" class="text-decoration-none text-dark">
            <h5 class="card-title">{{ post.title }}</h5>
            {% if not post.img_url %}
            <p class="card-text text-muted">{{ post.content|truncate(150) }}</p>
            {% endif %}
          </a>
          
          <div class="mt-auto">
            <span class="badge bg-primary mb-2">{{ post.category }}</span>
            <div class="d-flex justify-content-between align-items-center">
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary reaction-btn" data-post-id="{{ post.id }}" data-reaction="likes">
                  üëç {{ post.likes or 0 }}
                </button>
                <button class="btn btn-sm btn-outline-primary reaction-btn" data-post-id="{{ post.id }}" data-reaction="funny">
                  üòÇ {{ post.funny or 0 }}
                </button>
                <button class="btn btn-sm btn-outline-primary reaction-btn" data-post-id="{{ post.id }}" data-reaction="inspire">
                  ‚ú® {{ post.inspire or 0 }}
                </button>
              </div>
              <small class="text-muted">@{{ post.author.username }}</small>
            </div>
            
            {% if current_user.id == post.author.id %}
            <form method="POST" action="{{ url_for('post_delete', post_id=post.id) }}" class="mt-2">
              <button type="submit" class="btn btn-sm btn-danger w-100" 
                      onclick="return confirm('Delete this post permanently?')">
                <i class="bi bi-trash"></i> Delete
              </button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="col-12">
      <div class="text-center py-5">
        <h4 class="text-muted">No posts yet</h4>
        <p>Be the first to share your creation!</p>
        <a href="{{ url_for('create_post') }}" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Create Post
        </a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Add this before endblock -->
<script>
// AJAX for reactions
document.querySelectorAll('.reaction-btn').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const postId = e.target.dataset.postId;
    const reaction = e.target.dataset.reaction;
    
    try {
      const response = await fetch(`/react/${postId}/${reaction}`, {method: 'POST'});
      if(response.ok) {
        const data = await response.json();
        e.target.innerHTML = `${e.target.textContent.trim().split(' ')[0]} ${data.new_count}`;
      }
    } catch(err) {
      console.error('Reaction failed:', err);
    }
  });
});
</script>
{% endblock %}